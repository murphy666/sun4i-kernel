/* This is an autogenerated file */
/* Tag: noCheckHeader */

/*    CONFIDENTIAL */
/*    Copyright (C) Cambridge Silicon Radio Ltd 2008. All rights reserved. */

#include "event_pack_unpack/event_pack_unpack.h"
#include "fsm/fsm_internal.h"
#include "paldata_top_level_fsm/paldata_top_level_fsm.h"

CsrBool remote_paldata_acl_signal_receive(FsmContext* context, CsrUint8* buffer, CsrUint16 size)
{
    CsrUint8* tempbuffer = buffer;
    CsrUint16 id = event_unpack_CsrUint16(&tempbuffer);

    if (0x2550 == id) /* MA_UNITDATA_IND or MA_UNITDATA_CFM used only unit tests*/
    {
        PalAclDataReq_Evt evt;

        tempbuffer += 4; /* Skip the 4 bytes dest & sender */
        evt.dataLength =  event_unpack_CsrUint16(&tempbuffer);
        evt.data = NULL;
        if (evt.dataLength)
        {
            evt.data = (CsrUint8*)CsrPmalloc(evt.dataLength+16); /* 16 bytes of offset for Sys frame header (MAC Address & SNAP)*/
            event_unpack_buffer(&tempbuffer, evt.data+16, evt.dataLength); /* Copy ACL after offset */
        }
        evt.logicalLinkHandle =  event_unpack_CsrUint16(&tempbuffer);
        evt.aclOffset =  event_unpack_CsrUint16(&tempbuffer);
        evt.aclOffset =  16;
        evt.freeFunction = NULL;

        pal_acl_data_req(context, evt.dataLength, evt.data, evt.logicalLinkHandle, evt.aclOffset, evt.freeFunction);
        return TRUE;
    }
    else if (size>4)/* Assume this is a raw ACL packet. This can only work if ACL is connected dedicated communication point (for eg: dedicated port if sockets). */
    {
        PalAclDataReq_Evt evt;

        tempbuffer = buffer;
        evt.dataLength =  size;
        evt.data = NULL;
        if (evt.dataLength)
        {
            evt.data = (CsrUint8*)CsrPmalloc(evt.dataLength+16); /* 16 bytes of offset for Sys frame header (MAC Address & SNAP)*/
            event_unpack_buffer(&tempbuffer, evt.data+16, evt.dataLength); /* Copy ACL after offset */
        }
        evt.logicalLinkHandle =  0;
        evt.aclOffset =  16;
        evt.freeFunction =  NULL;

        pal_acl_data_req(context, evt.dataLength, evt.data, evt.logicalLinkHandle, evt.aclOffset, evt.freeFunction);
        return TRUE;
    }
    return FALSE;
}
